{% extends "base.html" %}

<!DOCTYPE html>
<html lang="en">
{% block content %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saved Lab Layouts</title>
</head>
<body>
    <h1>Saved Lab Layouts</h1>
    <ul>
        {% for layout in layouts %}
            <li>
                <a href="{% url 'get_saved_canvas' layout.id %}">Lab Name: {{ layout.name }}, Lab ID: {{ layout.id }} - Created on {{ layout.created_at }}</a>
                <button class="delete-btn" onclick="deleteLayout('{{ layout.id }}')">Delete</button>
            </li>
        {% endfor %}
    </ul>

<script>

const socket = new WebSocket('ws://' + window.location.host + '/ws/layouts/');

socket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    const layoutId = data.layout_id;

    // Remove the deleted layout from the DOM.
    const layoutElement = document.getElementById(`layout-${layoutId}`);
    if (layoutElement) {
        layoutElement.remove();
    }
};
    // Function to send the delete request.
    function deleteLayout(layoutId) {
        console.log("Attempting to delete layout with ID:", layoutId);

        fetch(`/delete_layout/${layoutId}/`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),  // CSRF for security
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Layout deleted successfully');
                // Remove the layout from the DOM if successfully deleted.
                const layoutElement = document.getElementById(`layout-${layoutId}`);
                if (layoutElement) {
                    layoutElement.remove();
                }
            } else {
            // Display error if attempt to remove layout failed.
                console.error('Error deleting layout:', data.error);
            }
        })
        .catch(error => console.error('Error:', error));
    }

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>

</body>
</html>
{% endblock %}