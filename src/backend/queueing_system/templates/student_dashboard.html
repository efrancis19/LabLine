<html>
<head>
{% extends 'base.html' %} 
{% load static %}
<link rel="stylesheet" href="{% static 'style.css' %}">
{% block content %}
    {% if user.is_authenticated %} 
        <a href="/logout/" class="btn btn-primary">Logout</a>
        <a class="nav-link" href="#">Your Requests</a>
        <a class="nav-link" href="#">Welcome, student {{ user.username }}</a>
{% endif %}
</head>

<body>
    <h2>Student Dashboard</h2>

    <!-- Help Request Form -->
    <form id="help-form">
        <label for="pc-number">PC Number:</label>
        <input type="text" id="pc-number" name="pc_number" required />
        <br>
        <label for="description">Issue Description:</label>
        <textarea id="description" name="description" required></textarea>
        <br>
        <button type="submit">Request Help</button>
    </form>

    <div id="messages"></div> <!-- Display messages and notifications -->

    <script type="text/javascript">
        let url = `ws://${window.location.host}/ws/student/`;
        let chatSocket;

        function connectWebSocket() {
            chatSocket = new WebSocket(url);

            chatSocket.onopen = function() {
                console.log('WebSocket connection established.');
            };

            chatSocket.onmessage = function(e) {
                let data = JSON.parse(e.data);
                console.log('Data:', data);

                if (data.type === 'help_response') {
                    let messages = document.getElementById('messages');
                    messages.insertAdjacentHTML('beforeend', `
                        <div>
                            <p><strong>Tutor Response:</strong> ${data.message}</p>
                        </div>
                    `);
                } else if (data.type === 'no_tutor') {
                    alert("No tutors available. Please try again later.");
                }
            };

            chatSocket.onclose = function(e) {
                console.log('WebSocket connection closed. Reconnecting in 3 seconds...', e);
                setTimeout(function() {
                    connectWebSocket();
                }, 3000); // Reconnect after 3 seconds
            };

            chatSocket.onerror = function(e) {
                console.error('WebSocket encountered an error:', e);
                chatSocket.close(); // Close and trigger the onclose event
            };
        }

        // Initialize WebSocket connection
        connectWebSocket();

        // Handle the help request form submission
        let form = document.getElementById('help-form');
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            let pcNumber = document.getElementById('pc-number').value;
            let description = document.getElementById('description').value;

            if (chatSocket.readyState === WebSocket.OPEN) {
                chatSocket.send(JSON.stringify({
                    'type': 'help_request',
                    'pc_number': pcNumber,
                    'description': description
                }));
                form.reset();
            } else {
                console.warn('WebSocket is not open. Message not sent.');
            }
        });
    </script>
{% endblock %}
</body>
</html>
