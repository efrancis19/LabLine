{% extends 'base.html' %}

{% block title %}Tutor Dashboard{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center mb-4">Welcome, {{ user.username }}, ({{ user.user_type }})</h2>

    <!-- Assigned Requests Section -->
    <div class="section-box mb-4">
        <h3 class="section-title">Assigned Requests</h3>
        <ul id="assigned-requests-list">
            {% for request in assigned_requests %}
                <li id="assigned-request-{{ request.id }}" class="request-card">
                    <div class="description"><strong>{{ request.student.username }}</strong> - {{ request.description }}</div>
                    <div class="meta-info">
                        <span><strong>PC:</strong> {{ request.student.pc_number }}</span>
                        <span><strong>Lab:</strong> {{ request.student.lab_id }}</span>
                    </div>
                    <button class="mark-completed" data-request-id="{{ request.id }}">Mark as Completed</button>
                </li>            
            {% empty %}
            {% endfor %}
        </ul>
    </div>

    <!-- Pending Requests Section -->
    <div class="section-box mb-4">
        <h3 class="section-title">Pending Requests</h3>
        <ul id="pending-requests-list">
            {% for request in pending_requests %}
                <li id="pending-request-{{ request.id }}" class="request-card">
                    <div class="description"><strong>{{ request.student.username }}</strong> - {{ request.description }}</div>
                    <div class="meta-info">
                        <span><strong>PC:</strong> {{ request.student.pc_number }}</span>
                        <span><strong>Lab:</strong> {{ request.student.lab_id }}</span>
                        {% if request.waiting_minutes is not None %}
                            <span class="wait-time">(Waiting for {{ request.waiting_minutes }} minutes)</span>
                        {% endif %}
                    </div>
                    {% if forloop.first and assigned_requests|length == 0 %}
                        <button class="accept-request" data-request-id="{{ request.id }}">Accept</button>
                    {% endif %}
                </li>            
            {% endfor %}
            </ul>
    </div>
</div>

<div>
    <form id="logoutAllForm" method="post" action="{% url 'force_logout_users' %}" style="margin-top: 1rem;">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger">
            Logout All Students & Tutors
        </button>
    </form>
</div>

<script type="text/javascript">

    // Function to connect to WebSocket for tutor dashboard updates
    function connectWebSocket(url, onMessage) {
        let socket = new WebSocket('ws://' + window.location.host + '/ws/dashboard/');
    
        socket.onload = function () {
            const pendingRequestsList = document.getElementById("pending-requests-list");
            if (pendingRequestsList.children.length === 0) {
                pendingRequestsList.innerHTML = '';
            }
        };
    
        socket.onopen = function () {
            console.log("WebSocket connected to", url);
        };
    
        socket.onmessage = onMessage;
    
        socket.onerror = function (error) {
            console.error("WebSocket error:", error);
        };
    
        socket.onclose = function () {
            console.error("WebSocket closed unexpectedly. Reconnecting...");
            setTimeout(function () {
                connectWebSocket(url, onMessage);
            }, 1000);
        };
    
        return socket;
    }
    
    // Update Accept button visibility
    function refreshAcceptButton() {
        const pendingRequestsList = document.getElementById("pending-requests-list");
        pendingRequestsList.querySelectorAll(".accept-request").forEach(btn => btn.remove());
    
        const assignedCount = document.getElementById("assigned-requests-list").children.length;
        if (assignedCount === 0 && pendingRequestsList.children.length > 0) {
            const firstItem = pendingRequestsList.children[0];
            const firstRequestId = firstItem.id.replace("pending-request-", "");
            const acceptButton = document.createElement("button");
            acceptButton.classList.add("accept-request");
            acceptButton.setAttribute("data-request-id", firstRequestId);
            acceptButton.textContent = "Accept";
            firstItem.appendChild(acceptButton);
        }
    }
    
    // WebSocket connection for dashboard updates
    const dashboardSocket = connectWebSocket(
        'ws://' + window.location.host + '/ws/dashboard/',
        function (e) {
            const data = JSON.parse(e.data);
            console.log("WebSocket message received:", data);
    
            if (data.type === 'new_request') {
                const pendingRequestsList = document.getElementById("pending-requests-list");
                const newRequestItem = document.createElement("li");
                newRequestItem.id = `pending-request-${data.request_id}`;
                newRequestItem.classList.add("request-card");
    
                newRequestItem.innerHTML = `
                    ${data.student} - ${data.description} PC Number: ${data.pc_number} Lab ID: ${data.lab_id}
                `;
    
                if (data.waiting_minutes !== undefined && data.waiting_minutes !== null) {
                    const waitTimeSpan = document.createElement("span");
                    waitTimeSpan.classList.add("wait-time");
                    waitTimeSpan.textContent = ` (Waiting for ${data.waiting_minutes} minutes)`;
                    newRequestItem.appendChild(waitTimeSpan);
                }
    
                if (pendingRequestsList.children.length === 0) {
                    const acceptButton = document.createElement("button");
                    acceptButton.classList.add("accept-request");
                    acceptButton.setAttribute("data-request-id", data.request_id);
                    acceptButton.textContent = "Accept";
                    newRequestItem.appendChild(acceptButton);
                }
    
                pendingRequestsList.appendChild(newRequestItem);
                refreshAcceptButton();
    
                pendingRequestsList.style.display = "none";
                setTimeout(() => {
                    pendingRequestsList.style.display = "block";
                }, 50);
            }
    
            else if (data.type === 'status_update') {
                const requestId = data.request_id;
                const newStatus = data.new_status;
    
                if (newStatus === "completed") {
                    const assignedRequest = document.getElementById(`assigned-request-${requestId}`);
                    if (assignedRequest) assignedRequest.remove();
                    refreshAcceptButton();
                }
    
                else if (newStatus === "canceled") {
                    const pendingRequest = document.getElementById(`pending-request-${requestId}`);
                    if (pendingRequest) pendingRequest.remove();
                    const assignedRequest = document.getElementById(`assigned-request-${requestId}`);
                    if (assignedRequest) assignedRequest.remove();
                    refreshAcceptButton();
                }
    
                else if (newStatus === "in_progress") {
                    const pendingRequest = document.getElementById(`pending-request-${requestId}`);
                    if (pendingRequest) pendingRequest.remove();
    
                    const assignedRequestsList = document.getElementById("assigned-requests-list");
                    const newAssignedItem = document.createElement("li");
                    newAssignedItem.id = `assigned-request-${requestId}`;
                    newAssignedItem.classList.add("request-card");
                    newAssignedItem.innerHTML = `
                        ${data.student} - ${data.description} PC Number: ${data.pc_number} Lab ID: ${data.lab_id}
                        <button class="mark-completed" data-request-id="${requestId}">Mark as Completed</button>
                    `;
                    assignedRequestsList.appendChild(newAssignedItem);
    
                    refreshAcceptButton();
                }
    
                else if (newStatus === "pending") {
                    const pendingRequest = document.getElementById(`pending-request-${requestId}`);
                    if (pendingRequest) {
                        const waitSpan = pendingRequest.querySelector(".wait-time");
                        if (data.waiting_minutes !== undefined && data.waiting_minutes !== null) {
                            if (!waitSpan) {
                                const newSpan = document.createElement("span");
                                newSpan.classList.add("wait-time");
                                newSpan.textContent = ` (Waiting for ${data.waiting_minutes} minutes)`;
                                pendingRequest.appendChild(newSpan);
                            } else {
                                waitSpan.textContent = ` (Waiting for ${data.waiting_minutes} minutes)`;
                            }
                        }
                    }
                }
            }
        }
    );
    
    // Event delegation for Accept and Mark Completed buttons
    document.addEventListener("click", function (event) {
        const target = event.target;
    
        if (target.classList.contains("accept-request")) {
            const requestId = target.getAttribute("data-request-id");
            fetch(`/accept_request/${requestId}/`, {
                method: "POST",
                headers: { "X-CSRFToken": "{{ csrf_token }}" }
            }).then(response => {
                if (response.ok) console.log("Request accepted successfully.");
            });
        }
    
        if (target.classList.contains("mark-completed")) {
            const requestId = target.getAttribute("data-request-id");
            fetch(`/mark_completed/${requestId}/`, {
                method: "POST",
                headers: { "X-CSRFToken": "{{ csrf_token }}" }
            }).then(response => {
                if (response.ok) console.log("Request marked as completed successfully.");
            });
        }
    });

    // Increment displayed wait time every 60 seconds
    setInterval(() => {
        document.querySelectorAll("#pending-requests-list .request-item").forEach(item => {
            const waitSpan = item.querySelector(".wait-time");
            if (waitSpan) {
                const match = waitSpan.textContent.match(/\d+/);
                if (match) {
                    const current = parseInt(match[0]);
                    const next = current + 1;
                    waitSpan.textContent = ` (Waiting for ${next} minutes)`;
                }
            }
        });
    }, 60000); // 60 seconds

</script>    

{% endblock %}
