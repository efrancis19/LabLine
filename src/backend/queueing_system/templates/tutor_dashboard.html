<html>
<head>
{% extends 'base.html' %}
{% block content %}
    {% if user.is_authenticated %}
        <a href="/logout/" class="btn btn-primary">Logout</a>
        <a class="nav-link" href="#">Request List</a>
        <a class="nav-link" href="#">Welcome, tutor {{ user.username }}</a>
    {% endif %}
</head>

<body>
    <h2>Tutor Dashboard</h2>

    <div id="help-requests"></div> <!-- Display incoming help requests -->

    <script type="text/javascript">
        let url = `ws://${window.location.host}/ws/tutor/`;
        let chatSocket;

        function connectWebSocket() {
            chatSocket = new WebSocket(url);

            chatSocket.onopen = function() {
                console.log('WebSocket connection established.');
            };

            chatSocket.onmessage = function(e) {
                let data = JSON.parse(e.data);
                console.log('Data:', data);

                if (data.type === 'help_request') {
                    let helpRequests = document.getElementById('help-requests');
                    helpRequests.insertAdjacentHTML('beforeend', `
                        <div>
                            <p><strong>Student Request from PC ${data.pc_number}:</strong> ${data.message}</p>
                            <button onclick="respondToStudent('${data.student_channel}', 'I am on my way!')">Respond</button>
                        </div>
                    `);
                }
            };

            chatSocket.onclose = function(e) {
                console.log('WebSocket connection closed. Reconnecting in 3 seconds...', e);
                setTimeout(function() {
                    connectWebSocket();
                }, 3000); // Reconnect after 3 seconds
            };

            chatSocket.onerror = function(e) {
                console.error('WebSocket encountered an error:', e);
                chatSocket.close(); // Close and trigger the onclose event
            };
        }

        // Initialize WebSocket connection
        connectWebSocket();

        // Function to respond to student requests
        function respondToStudent(studentChannel, message) {
            if (chatSocket.readyState === WebSocket.OPEN) {
                chatSocket.send(JSON.stringify({
                    'type': 'help_response',
                    'student_channel': studentChannel,
                    'message': message
                }));
            } else {
                console.warn('WebSocket is not open. Response not sent.');
            }
        }
    </script>
{% endblock %}
</body>
</html>
