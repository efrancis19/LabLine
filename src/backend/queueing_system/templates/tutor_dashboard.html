{% extends 'base.html' %}

{% block title %}Tutor Dashboard{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center mb-4">Welcome, {{ user.username }}</h2>

    <!-- Assigned Requests Section -->
    <div class="section-box mb-4">
        <h3 class="section-title">Assigned Requests</h3>
        <ul id="assigned-requests-list">
            {% for request in assigned_requests %}
            <li id="assigned-request-{{ request.id }}" class="request-item">
                <b>{{ request.student.username }}</b> - {{ request.description }}
                <button class="mark-completed" data-request-id="{{ request.id }}">Mark as Completed</button>
            </li>
            {% empty %}
            {% endfor %}
        </ul>
    </div>

    <!-- Pending Requests Section -->
    <div class="section-box mb-4">
        <h3 class="section-title">Pending Requests</h3>
        <ul id="pending-requests-list">
            {% for request in pending_requests %}
                {% if forloop.first and assigned_requests|length == 0 %}
                    <li id="pending-request-{{ request.id }}" class="request-item">
                    <b>{{ forloop.counter }}. {{ request.student.username }}</b> - {{ request.description }}
                    <button class="accept-request" data-request-id="{{ request.id }}">Accept</button>
                {% elif forloop.first and assigned_requests|length > 0 %}
                    <li id="pending-request-{{ request.id }}" class="request-item">
                    <b>{{ forloop.counter }}. {{ request.student.username }}</b> - {{ request.description }}
                {% else %}
                    <li id="pending-request-{{ request.id }}" class="request-item">
                    <b>{{ forloop.counter }}. {{ request.student.username }}</b> - {{ request.description }}
                {% endif %}
            </li>
            </ul>
            {% endfor %}
    </div>
</div>

<script type="text/javascript">
// Connect to the WebSocket for tutor dashboard updates through the url '/ws/dashboard/'
function connectWebSocket(url, onMessage) {
    let socket = new WebSocket('ws://' + window.location.host + '/ws/dashboard/');
    socket.onload = function () {
        const pendingRequestsList = document.getElementById("pending-requests-list");
        if (pendingRequestsList.children.length === 0) {
            pendingRequestsList.innerHTML = '';
        }
    };

    socket.onopen = function () {
        console.log("WebSocket connected to", url);
    };

    socket.onmessage = onMessage;

    socket.onerror = function (error) {
        console.error("WebSocket error:", error);
    };

    socket.onclose = function () {
        console.error("WebSocket closed unexpectedly. Reconnecting...");
        setTimeout(function () {
            connectWebSocket(url, onMessage);
        }, 1000);
    };

    return socket;
}

// WebSocket connection for dashboard updates
const dashboardSocket = connectWebSocket(
    'ws://' + window.location.host + '/ws/dashboard/',
    function (e) {
        const data = JSON.parse(e.data);
        console.log("WebSocket message received:", data);

        // Check if the data type is a new request
        if (data.type === 'new_request') {
            const pendingRequestsList = document.getElementById("pending-requests-list");
            const newRequestItem = document.createElement("li");

            // Ensure the request-item class is applied immediately
            newRequestItem.id = `pending-request-${data.request_id}`;
            newRequestItem.classList.add("request-item");

            // Set the innerHTML outside of the if statement
            newRequestItem.innerHTML = `
                ${data.student} - ${data.description}
            `;

            // Ensure the first item gets the Accept button
            if (pendingRequestsList.children.length === 0) {
                const acceptButton = document.createElement("button");
                acceptButton.classList.add("accept-request");
                acceptButton.setAttribute("data-request-id", data.request_id);
                acceptButton.textContent = "Accept";
                newRequestItem.appendChild(acceptButton);
            }
        
            pendingRequestsList.appendChild(newRequestItem);
        
            // Force CSS reflow to ensure styles apply
            pendingRequestsList.style.display = "none";
            setTimeout(() => {
                pendingRequestsList.style.display = "block";
            }, 50);
        }


        // If the data type is 'status_update', handle the status update of a request
        else if (data.type === 'status_update') {
            const requestId = data.request_id;
            const newStatus = data.new_status;

            // Remove from assigned requests if completed
            if (newStatus === "completed") {
                const assignedRequest = document.getElementById(`assigned-request-${requestId}`);
                if (assignedRequest) assignedRequest.remove();

                // Update the next pending request to show the "Accept" button
                const pendingRequestsList = document.getElementById("pending-requests-list");
                if (pendingRequestsList.children.length > 0) {
                    const firstItem = pendingRequestsList.children[0];
                    if (!firstItem.querySelector(".accept-request")) {
                        const firstRequestId = firstItem.id.replace("pending-request-", "");
                        const acceptButton = document.createElement("button");
                        acceptButton.classList.add("accept-request");
                        acceptButton.setAttribute("data-request-id", firstRequestId);
                        acceptButton.textContent = "Accept";
                        firstItem.appendChild(acceptButton);
                    }
                }
            }

            else if (newStatus === "canceled") {
                console.log(`Request ${requestId} was canceled.`);
                const pendingRequest = document.getElementById(`pending-request-${requestId}`);
                if (pendingRequest) pendingRequest.remove();
                const assignedRequest = document.getElementById(`assigned-request-${requestId}`);
                if (assignedRequest) assignedRequest.remove();
            } 

            else if (newStatus === "in_progress") {
                const pendingRequest = document.getElementById(`pending-request-${requestId}`);
                if (pendingRequest) pendingRequest.remove();

                const pendingRequestsList = document.getElementById("pending-requests-list");
                if (pendingRequestsList.children.length > 0) {
                    const firstItem = pendingRequestsList.children[0];
                    if (!firstItem.querySelector(".accept-request")) {
                        const firstRequestId = firstItem.id.replace("pending-request-", "");
                        const acceptButton = document.createElement("button");
                        acceptButton.classList.add("accept-request");
                        acceptButton.setAttribute("data-request-id", firstRequestId);
                        acceptButton.textContent = "Accept";
                        firstItem.appendChild(acceptButton);
                    }
                }

                const assignedRequestsList = document.getElementById("assigned-requests-list");
                const newAssignedItem = document.createElement("li");
                newAssignedItem.id = `assigned-request-${requestId}`;
                newAssignedItem.innerHTML = `
                    ${data.student} - ${data.description}
                    <button class="mark-completed" data-request-id="${requestId}">Mark as Completed</button>
                `;
                assignedRequestsList.appendChild(newAssignedItem);
            }
        }
    }
);

// Add event listeners for dynamically generated buttons
document.addEventListener("click", function (event) {
    const target = event.target;

    if (target.classList.contains("accept-request")) {
        const requestId = target.getAttribute("data-request-id");
        fetch(`/accept_request/${requestId}/`, { method: "POST", headers: { "X-CSRFToken": "{{ csrf_token }}" } })
            .then((response) => {
                if (response.ok) console.log("Request accepted successfully.");
            });
    }

    if (target.classList.contains("mark-completed")) {
        const requestId = target.getAttribute("data-request-id");
        fetch(`/mark_completed/${requestId}/`, { method: "POST", headers: { "X-CSRFToken": "{{ csrf_token }}" } })
            .then((response) => {
                if (response.ok) console.log("Request marked as completed successfully.");
            });
    }
});
</script>

{% endblock %}
