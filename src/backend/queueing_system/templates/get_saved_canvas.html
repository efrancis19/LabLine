<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saved Lab</title>
    <style>
        canvas {
            border: 1px solid black;
        }
    </style>
</head>
<body>
    <h1>Saved Lab Layout</h1>
    <pre>Raw layoutData: {{ layout_data|safe }}</pre>
    <canvas id="myLab" width="500" height="500"></canvas>

    <script type="application/json" id="layoutData">
        {{ layout_data|safe }}
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            console.log("JavaScript Loaded Successfully!");

            // Retrieve the layout data from the script tag.
            const layoutDataElement = document.getElementById('layoutData');
            if (!layoutDataElement) {
                console.error("Error: layout_data script tag not found!");
                return;
            }

            const layoutDataText = layoutDataElement.textContent.trim();
            console.log("Raw layout data from the script tag:", layoutDataText);

            let layoutData = [];
            
            try {
                console.log("Parsing layoutData:", layoutDataText);
                layoutData = JSON.parse(layoutDataText);
                console.log("Parsed layoutData:", layoutData);
            } catch (error) {
                console.error("Error parsing layout data:", error);
                console.error("Raw data causing error:", layoutDataText);
                return;
            }

            if (!Array.isArray(layoutData) || layoutData.length === 0) {
        console.error("Invalid layoutData: Not an array or empty");
    } else {
        console.log("Valid lab layout received:", layoutData);
    }

            // Canvas setup.
            const canvas = document.getElementById('myLab');
            if (!canvas) {
                console.error("Error: Lab not found!");
                return;
            }

            const ctx = canvas.getContext('2d');
            const selectedPC = "{{ selected_pc|default:'' }}";

            // Function to draw the layout on the canvas.
            function drawLab() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (Array.isArray(layoutData)) {
                    console.log("Valid lab layout received:", layoutData);
                    layoutData.forEach(PC => {
                        if (typeof PC.x === 'number' && typeof PC.y === 'number' && typeof PC.size === 'number') {
                            const isSelected = selectedPC && String(pc.id) === String(selectedPC);
                            ctx.fillStyle = isSelected ? 'green' : 'blue';
                            ctx.fillRect(PC.x, PC.y, PC.size, PC.size);

                            ctx.fillStyle = 'white';
                            ctx.font = '14px Arial';
                            ctx.fillText(PC.id, PC.x + 15, PC.y + 30);
                        } else {
                            console.error("Invalid PC data:", PC);
                        }
                    });
                } else {
                    console.error("Invalid layoutData: Not an array or empty");
                }
            }

            // Call the drawLab function to draw the layout.
            drawLab();
        });
    </script>